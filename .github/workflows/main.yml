name: CI/CD Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm test

  deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: SSH and deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        env:
          HUBSPOT_API_KEY: ${{ secrets.HUBSPOT_API_KEY }}
          HUBSPOT_WEBHOOK_SECRET: ${{ secrets.HUBSPOT_WEBHOOK_SECRET }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          envs: HUBSPOT_API_KEY,HUBSPOT_WEBHOOK_SECRET,DB_HOST,DB_PORT,DB_USERNAME,DB_PASSWORD,DB_DATABASE
          script: |
            cd ~/moca-hubspot
            git pull origin main

            # Set docker-compose path
            DOCKER_COMPOSE="$HOME/bin/docker-compose"

            # Install docker-compose if not available (in user's home directory)
            if [ ! -f "$DOCKER_COMPOSE" ]; then
              echo "Installing docker-compose..."
              mkdir -p ~/bin
              curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o "$DOCKER_COMPOSE"
              chmod +x "$DOCKER_COMPOSE"
            fi

            # Create .env.production with secrets from GitHub Actions
            echo "üìù Creating .env.production with secrets from GitHub Actions..."
            cat > .env.production << EOF
            # Node Environment
            NODE_ENV=production
            PORT=3000

            # Database Configuration
            DB_HOST=${DB_HOST}
            DB_PORT=${DB_PORT}
            DB_USERNAME=${DB_USERNAME}
            DB_PASSWORD=${DB_PASSWORD}
            DB_DATABASE=${DB_DATABASE}

            # HubSpot Configuration
            HUBSPOT_API_KEY=${HUBSPOT_API_KEY}
            HUBSPOT_WEBHOOK_SECRET=${HUBSPOT_WEBHOOK_SECRET}

            # Application Configuration
            APP_MODE=production
            EOF
            echo "‚úÖ .env.production created successfully"

            # Copy .env.production to .env for docker-compose to read
            cp .env.production .env
            echo "‚úÖ Copied .env.production to .env"

            # Clean up Docker resources to free disk space
            echo "Cleaning up Docker resources..."
            docker system prune -af --volumes || true

            # Stop existing containers gracefully
            echo "Stopping existing containers..."
            $DOCKER_COMPOSE down || true

            # Force remove any lingering containers with the same names
            echo "Removing any lingering containers..."
            docker rm -f moca-container moca-postgres 2>/dev/null || true

            # Build and tag image with commit SHA for tracking
            IMAGE_TAG="moca-nest:${{ github.sha }}"
            echo "Building image: $IMAGE_TAG"
            docker build -t moca-nest:latest -t $IMAGE_TAG .

            # Start services with Docker Compose (with --build to ensure fresh build)
            echo "Starting services with Docker Compose..."
            $DOCKER_COMPOSE up -d --build

            # Wait for services to be healthy
            echo "Waiting for services to be healthy..."
            sleep 15

            # Check if app is responding
            HEALTHY=false
            for i in {1..6}; do
              echo "Health check attempt $i/6..."
              if curl -f http://localhost:3000/ > /dev/null 2>&1; then
                echo "‚úì Application is healthy!"
                HEALTHY=true
                break
              fi
              if [ $i -lt 6 ]; then
                echo "‚úó Health check failed, retrying in 5 seconds..."
                sleep 5
              fi
            done

            if [ "$HEALTHY" = true ]; then
              echo "üéâ Deployment successful!"

              # Show running containers
              $DOCKER_COMPOSE ps

              # Clean up old images (keep last 3)
              docker images moca-nest --format "{{.ID}}" | tail -n +4 | xargs -r docker rmi || true
            else
              echo "‚ùå Deployment failed - application is not healthy"
              echo "Rolling back..."
              $DOCKER_COMPOSE down
              exit 1
            fi
