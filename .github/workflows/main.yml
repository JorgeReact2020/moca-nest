name: CI/CD Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm test

  deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: SSH and deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        env:
          HUBSPOT_API_KEY: ${{ secrets.HUBSPOT_API_KEY }}
          HUBSPOT_WEBHOOK_SECRET: ${{ secrets.HUBSPOT_WEBHOOK_SECRET }}
          DB_HOST: ${{ secrets.DB_HOST }}
          DB_PORT: ${{ secrets.DB_PORT }}
          DB_USERNAME: ${{ secrets.DB_USERNAME }}
          DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
          DB_DATABASE: ${{ secrets.DB_DATABASE }}
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          envs: HUBSPOT_API_KEY,HUBSPOT_WEBHOOK_SECRET,DB_HOST,DB_PORT,DB_USERNAME,DB_PASSWORD,DB_DATABASE
          script: |
            cd ~/moca-hubspot
            git pull origin main

            # Set docker-compose path
            DOCKER_COMPOSE="$HOME/bin/docker-compose"

            # Install docker-compose if not available (in user's home directory)
            if [ ! -f "$DOCKER_COMPOSE" ]; then
              echo "Installing docker-compose..."
              mkdir -p ~/bin
              curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o "$DOCKER_COMPOSE"
              chmod +x "$DOCKER_COMPOSE"
            fi

            # Create .env.production with secrets from GitHub Actions
            echo "üìù Creating .env.production with secrets from GitHub Actions..."
            cat > .env.production << EOF
            # Node Environment
            NODE_ENV=production
            PORT=3000

            # Database Configuration
            DB_HOST=${DB_HOST}
            DB_PORT=${DB_PORT}
            DB_USERNAME=${DB_USERNAME}
            DB_PASSWORD=${DB_PASSWORD}
            DB_DATABASE=${DB_DATABASE}

            # HubSpot Configuration
            HUBSPOT_API_KEY=${HUBSPOT_API_KEY}
            HUBSPOT_WEBHOOK_SECRET=${HUBSPOT_WEBHOOK_SECRET}

            # Application Configuration
            APP_MODE=production
            EOF
            echo "‚úÖ .env.production created successfully"

            # Copy .env.production to .env for docker-compose to read
            cp .env.production .env
            echo "‚úÖ Copied .env.production to .env"

            # Clean up Docker resources to free disk space (but keep volumes!)
            echo "Cleaning up Docker resources (preserving volumes)..."
            docker system prune -af || true

            # Stop existing containers gracefully
            echo "Stopping existing containers..."
            $DOCKER_COMPOSE down || true

            # Force remove any lingering containers with the same names
            echo "Removing any lingering containers..."
            docker rm -f moca-container moca-postgres 2>/dev/null || true

            # Build and tag image with commit SHA for tracking
            IMAGE_TAG="moca-nest:${{ github.sha }}"
            echo "Building image: $IMAGE_TAG"
            docker build -t moca-nest:latest -t $IMAGE_TAG .

            # Start services with Docker Compose (with --build to ensure fresh build)
            echo "Starting services with Docker Compose..."
            $DOCKER_COMPOSE up -d --build

            # Show container status immediately
            echo "üìä Container status:"
            $DOCKER_COMPOSE ps

            # Wait for database to be ready
            echo "Waiting for database to be ready..."
            sleep 10

            # Ensure database exists
            echo "üìä Ensuring database exists..."
            DB_EXISTS=$(docker exec moca-postgres psql -U ${DB_USERNAME} -lqt | cut -d \| -f 1 | grep -w ${DB_DATABASE} | wc -l)
            
            if [ "$DB_EXISTS" -eq "0" ]; then
              echo "‚ö†Ô∏è  Database '${DB_DATABASE}' does not exist. Creating it..."
              docker exec moca-postgres psql -U ${DB_USERNAME} -c "CREATE DATABASE ${DB_DATABASE};"
              echo "‚úÖ Database '${DB_DATABASE}' created successfully"
            else
              echo "‚úÖ Database '${DB_DATABASE}' already exists"
            fi

            # Check database health
            echo "Checking database container..."
            docker logs moca-postgres --tail 20

            # Wait for app container to start
            echo "Waiting for application to start..."
            sleep 15

            # Show app logs for debugging
            echo "üìã Application logs (last 50 lines):"
            docker logs moca-container --tail 50

            # Check if containers are running
            APP_RUNNING=$(docker ps --filter "name=moca-container" --filter "status=running" -q)
            DB_RUNNING=$(docker ps --filter "name=moca-postgres" --filter "status=running" -q)

            if [ -z "$APP_RUNNING" ]; then
              echo "‚ùå Application container is not running!"
              echo "Full container logs:"
              docker logs moca-container
              $DOCKER_COMPOSE down
              exit 1
            fi

            if [ -z "$DB_RUNNING" ]; then
              echo "‚ùå Database container is not running!"
              docker logs moca-postgres
              $DOCKER_COMPOSE down
              exit 1
            fi

            # Check if app is responding
            HEALTHY=false
            for i in {1..10}; do
              echo "Health check attempt $i/10..."

              # Try health endpoint first, then root
              if curl -f http://localhost:3000/ > /dev/null 2>&1 || curl -f http://localhost:3000/health > /dev/null 2>&1; then
                echo "‚úì Application is healthy!"
                HEALTHY=true
                break
              fi

              if [ $i -lt 10 ]; then
                echo "‚úó Health check failed, retrying in 10 seconds..."
                echo "Recent logs:"
                docker logs moca-container --tail 10
                sleep 10
              fi
            done

            if [ "$HEALTHY" = true ]; then
              echo "üéâ Deployment successful!"

              # Show running containers
              $DOCKER_COMPOSE ps

              # Show final app status
              echo "Final application logs (last 20 lines):"
              docker logs moca-container --tail 20

              # Clean up old images (keep last 3)
              docker images moca-nest --format "{{.ID}}" | tail -n +4 | xargs -r docker rmi || true
            else
              echo "‚ùå Deployment failed - application is not healthy"
              echo "Full application logs:"
              docker logs moca-container
              echo "Full database logs:"
              docker logs moca-postgres
              echo "Rolling back..."
              $DOCKER_COMPOSE down
              exit 1
            fi
