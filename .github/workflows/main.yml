name: CI/CD Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm test

  deploy:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: SSH and deploy to EC2
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          script: |
            cd ~/moca-hubspot
            git pull origin main

            # Ensure .env file exists for production
            if [ ! -f .env ]; then
              echo "âš ï¸  Creating .env from .env.production template"
              cp .env.production .env
              echo "âš ï¸  WARNING: Please update database credentials in .env file!"
            fi

            # Stop existing containers gracefully
            echo "Stopping existing containers..."
            docker-compose down || true

            # Build new image with commit SHA tag
            IMAGE_TAG="moca-nest:${{ github.sha }}"
            docker build -t moca-nest:latest -t $IMAGE_TAG .

            # Start services with Docker Compose
            echo "Starting services with Docker Compose..."
            docker-compose up -d

            # Wait for services to be healthy
            echo "Waiting for services to be healthy..."
            sleep 15

            # Check if app is responding
            HEALTHY=false
            for i in {1..6}; do
              echo "Health check attempt $i/6..."
              if curl -f http://localhost:3000/ > /dev/null 2>&1; then
                echo "âœ“ Application is healthy!"
                HEALTHY=true
                break
              fi
              if [ $i -lt 6 ]; then
                echo "âœ— Health check failed, retrying in 5 seconds..."
                sleep 5
              fi
            done

            if [ "$HEALTHY" = true ]; then
              echo "ðŸŽ‰ Deployment successful!"

              # Show running containers
              docker-compose ps

              # Clean up old images (keep last 3)
              docker images moca-nest --format "{{.ID}}" | tail -n +4 | xargs -r docker rmi || true
            else
              echo "âŒ Deployment failed - application is not healthy"
              echo "Rolling back..."
              docker-compose down
              exit 1
            fi

              # Clean up old images (keep last 3)
              docker images moca-nest --format "{{.ID}}" | tail -n +4 | xargs -r docker rmi || true
            else
              echo "New container failed health check, rolling back..."
              docker stop moca-container-new 2>/dev/null || true
              docker rm moca-container-new 2>/dev/null || true
              exit 1
            fi
